<html>

<head>
	<title>Huge Transactions Monitor</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet">
</head>
<body>
	<h2>Huge transactions real-time alerts</h2>
	<div class="container">
		<div class="row">
			<div class="col-12">
				<div class="card">
					<div class="card-body">
						<canvas id="canvas"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!--suppress JSUnresolvedLibraryURL -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
	<!--suppress JSUnresolvedLibraryURL -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<!--suppress JSUnresolvedLibraryURL -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>

	<section class="ftco-section">
		<div id="demo" class="container">
			<table>
				<tr>
					<td>Time &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</td>
					<td>symbol &emsp;&emsp;&emsp;</td> 
					<td>price &emsp;&emsp;&emsp;</td>
					<td>usd &emsp;&emsp;&emsp;</td>
					<td>action &emsp;&emsp;&emsp;</td>
					<td>source &emsp;&emsp;&emsp;</td>
					<td>dest &emsp;</td>
				</tr>
			</table>
		</div>
	</section>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.min.js"></script>

	<script>
	
	var speed = 15;
	var sizeLimit = 35;
	var i = 0;

	function typeWriter(txt, i) {
	var text = "" + txt;
		if (text.length !== undefined && i < text.length) {
			document.getElementById("demo").innerHTML += text.charAt(i);
			setTimeout(typeWriter, speed, text, i+1);
		}
	}

	function showText(txt) {
		if (i > sizeLimit) {
			document.getElementById("demo").innerHTML = '';
			i = 0;
		}
		document.getElementById("demo").innerHTML += txt;
		document.getElementById("demo").innerHTML += "<br>";
	i++;
	}

	//chartJs plot
	$(document).ready(function () {
		const config = {
			type: 'line',
			data: {
				labels: [],
				datasets: [{
					label: "Random Dataset",
					backgroundColor: 'rgb(255, 99, 132)',
					borderColor: 'rgb(255, 99, 132)',
					data: [],
					fill: false,
				}],
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Creating Real-Time Charts with Flask'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Time'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Value'
						}
					}]
				}
			}
		};

	const context = document.getElementById('canvas').getContext('2d');
	const lineChart = new Chart(context, config);

	// create a event source
	var eventSource = new EventSource("/whaleProducer");
	// whale text producer
	eventSource.addEventListener("whale", function(e) {
		rows = JSON.parse(e.data);

		let unix_timestamp = parseInt(rows['timestamp'])
		var date = new Date(unix_timestamp * 1000);
		var months = ['01','02','03','04','05','06','07','08','09','10','11','12'];
		var year = date.getFullYear();
	    var month = months[date.getMonth()];
		var day = date.getDate();
		// Hours part from the timestamp
		var hours = date.getHours();
		// Minutes part from the timestamp
		var minutes = "0" + date.getMinutes();
		// Seconds part from the timestamp
		var seconds = "0" + date.getSeconds();

		// Will display time in 10:30:23 format
		var formattedTime = year + '-' + month + '-' + day + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);

		document.getElementById("demo").innerHTML += "<table><tr>"
		document.getElementById("demo").innerHTML += "<td>" + formattedTime + "&emsp;&emsp;</td>";
		document.getElementById("demo").innerHTML += "<td>" + rows['symbol'] + "&emsp;&emsp;&emsp;&emsp;&emsp;</td>";
		document.getElementById("demo").innerHTML += "<td>" + rows['price'] + "&emsp;&emsp;&emsp;</td>";
		document.getElementById("demo").innerHTML += "<td>" + rows['usd'] + "&emsp;&emsp;&emsp;&emsp;</td>";
		document.getElementById("demo").innerHTML += "<td>" + rows['action'] + "&emsp;&emsp;&emsp;&emsp;</td>";
		document.getElementById("demo").innerHTML += "<td>" + rows['source'] + "&emsp;&emsp;&emsp;&emsp;</td>";
		document.getElementById("demo").innerHTML += "<td>" + rows['dest'] + "</td>";
		document.getElementById("demo").innerHTML += "</tr></table>";

	  }, true);

	</script>
</body>
</html>
